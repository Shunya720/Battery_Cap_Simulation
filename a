import dash
from dash import dcc, html, Input, Output, State, callback_context, dash_table
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import pandas as pd
import numpy as np
import base64
import io
import json
from typing import List, Dict, Tuple

# Dashã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
app = dash.Dash(__name__)
app.title = "ç™ºé›»æ©Ÿæ§‹æˆè¨ˆç®—ãƒ„ãƒ¼ãƒ«"

# ã‚«ã‚¹ã‚¿ãƒ CSS
app.layout = html.Div([
    dcc.Store(id='generators-store'),
    dcc.Store(id='demand-store'),
    dcc.Store(id='uc-result-store'),
    dcc.Store(id='ed-result-store'),
    dcc.Store(id='solver-config-store', data={
        'margin_dg': 0.1,
        'margin_gt': 0.15,
        'stop_margin_dg': 0.05,
        'stop_margin_gt': 0.08,
        'lambda_min': 0.0,
        'lambda_max': 100.0,
        'lambda_tolerance': 0.001
    }),
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼
    html.Div([
        html.H1("âš¡ ç™ºé›»æ©Ÿæ§‹æˆè¨ˆç®—ãƒ„ãƒ¼ãƒ«", 
                style={'text-align': 'center', 'color': 'white', 'margin': '0'}),
    ], style={
        'background': 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)',
        'padding': '2rem',
        'border-radius': '10px',
        'margin-bottom': '2rem'
    }),
    
    # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    html.Div([
        # ã‚µã‚¤ãƒ‰ãƒãƒ¼
        html.Div([
            html.H3("âš™ï¸ è¨ˆç®—è¨­å®š", style={'margin-bottom': '1rem'}),
            
            # æ§‹æˆè¨ˆç®—è¨­å®š
            html.H4("ğŸ“‹ æ§‹æˆè¨ˆç®—è¨­å®š"),
            html.Label("DGãƒãƒ¼ã‚¸ãƒ³ç‡ (%)"),
            dcc.Slider(id='margin-dg-slider', min=0, max=30, value=10, step=1,
                      marks={i: f'{i}%' for i in range(0, 31, 5)},
                      tooltip={"placement": "bottom", "always_visible": True}),
            
            html.Label("GTãƒãƒ¼ã‚¸ãƒ³ç‡ (%)"),
            dcc.Slider(id='margin-gt-slider', min=0, max=30, value=15, step=1,
                      marks={i: f'{i}%' for i in range(0, 31, 5)},
                      tooltip={"placement": "bottom", "always_visible": True}),
            
            html.Label("DGè§£åˆ—ãƒãƒ¼ã‚¸ãƒ³ç‡ (%)"),
            dcc.Slider(id='stop-margin-dg-slider', min=0, max=20, value=5, step=1,
                      marks={i: f'{i}%' for i in range(0, 21, 5)},
                      tooltip={"placement": "bottom", "always_visible": True}),
            
            html.Label("GTè§£åˆ—ãƒãƒ¼ã‚¸ãƒ³ç‡ (%)"),
            dcc.Slider(id='stop-margin-gt-slider', min=0, max=20, value=8, step=1,
                      marks={i: f'{i}%' for i in range(0, 21, 5)},
                      tooltip={"placement": "bottom", "always_visible": True}),
            
            html.Hr(),
            
            # çµŒæ¸ˆé…åˆ†è¨­å®š
            html.H4("âš¡ çµŒæ¸ˆé…åˆ†è¨­å®š"),
            html.Label("Î»æœ€å°å€¤"),
            dcc.Input(id='lambda-min-input', type='number', value=0.0, step=1.0),
            
            html.Label("Î»æœ€å¤§å€¤"),
            dcc.Input(id='lambda-max-input', type='number', value=100.0, step=1.0),
            
            html.Label("Î»è¨±å®¹èª¤å·® (kW)"),
            dcc.Input(id='lambda-tolerance-input', type='number', value=0.001, step=0.001),
            
        ], style={
            'width': '25%',
            'float': 'left',
            'padding': '1rem',
            'background': '#f8f9fa',
            'border-radius': '10px',
            'margin-right': '2%'
        }),
        
        # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢
        html.Div([
            # éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            html.Div([
                html.H2("ğŸ“Š éœ€è¦äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"),
                dcc.Upload(
                    id='upload-demand',
                    children=html.Div([
                        'ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦éœ€è¦äºˆæ¸¬CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ'
                    ]),
                    style={
                        'width': '100%',
                        'height': '60px',
                        'lineHeight': '60px',
                        'borderWidth': '1px',
                        'borderStyle': 'dashed',
                        'borderRadius': '5px',
                        'textAlign': 'center',
                        'margin': '10px'
                    },
                    multiple=False
                ),
                html.Div(id='demand-upload-status'),
                html.Div(id='demand-preview'),
            ], style={'margin-bottom': '2rem'}),
            
            # ç™ºé›»æ©Ÿè¨­å®š
            html.Div([
                html.H2("ğŸ”§ ç™ºé›»æ©Ÿè¨­å®š"),
                html.Label("ç™ºé›»æ©Ÿå°æ•°"),
                dcc.Input(id='num-generators-input', type='number', value=8, min=1, max=20),
                html.Br(), html.Br(),
                html.Button("ç™ºé›»æ©Ÿè¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ", id='generate-gen-table-btn', 
                           style={'margin-bottom': '1rem'}),
                html.Div(id='generator-config-table'),
                html.Button("ç™ºé›»æ©Ÿè¨­å®šã‚’ä¿å­˜", id='save-generators-btn', 
                           style={'margin-top': '1rem', 'background': '#28a745', 'color': 'white'}),
                html.Div(id='generator-save-status'),
            ], style={'margin-bottom': '2rem'}),
            
            # è¨ˆç®—å®Ÿè¡Œ
            html.Div([
                html.H2("âš¡ æ§‹æˆè¨ˆç®—ãƒ»çµŒæ¸ˆé…åˆ†å®Ÿè¡Œ"),
                html.Div([
                    html.Button("ğŸ”§ æ§‹æˆè¨ˆç®—ã®ã¿å®Ÿè¡Œ", id='run-uc-btn', 
                               style={'margin-right': '1rem', 'background': '#6c757d', 'color': 'white'}),
                    html.Button("ğŸš€ æ§‹æˆè¨ˆç®—ï¼‹çµŒæ¸ˆé…åˆ†å®Ÿè¡Œ", id='run-both-btn',
                               style={'background': '#007bff', 'color': 'white'}),
                ]),
                html.Div(id='calculation-status'),
            ], style={'margin-bottom': '2rem'}),
            
            # çµæœè¡¨ç¤º
            html.Div([
                html.H2("ğŸ“ˆ è¨ˆç®—çµæœ"),
                dcc.Tabs(id='result-tabs', value='uc-tab', children=[
                    dcc.Tab(label='ğŸ“Š æ§‹æˆè¨ˆç®—çµæœ', value='uc-tab'),
                    dcc.Tab(label='âš¡ çµŒæ¸ˆé…åˆ†çµæœ', value='ed-tab'),
                    dcc.Tab(label='ğŸ“Š çµ±è¨ˆæƒ…å ±', value='stats-tab'),
                ]),
                html.Div(id='result-content'),
            ], id='results-section', style={'display': 'none'}),
            
        ], style={'width': '73%', 'float': 'right'}),
        
    ], style={'clear': 'both', 'margin': '0'}),
    
], style={'padding': '1rem', 'font-family': 'Arial, sans-serif'})

# ç™ºé›»æ©Ÿè¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
def get_default_generator_config(index: int) -> dict:
    """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç™ºé›»æ©Ÿè¨­å®šã‚’å–å¾—"""
    defaults = {
        0: {"name": "DG3", "type": "DG", "min": 5000, "max": 10000, "priority": 1, 
            "heat_a": 4.8e-06, "heat_b": 0.1120, "heat_c": 420,
            "startup_cost": 25893, "shutdown_cost": 42084},
        1: {"name": "DG4", "type": "DG", "min": 5000, "max": 10000, "priority": 2, 
            "heat_a": 1.0e-07, "heat_b": 0.1971, "heat_c": 103,
            "startup_cost": 23116, "shutdown_cost": 50116},
        2: {"name": "DG5", "type": "DG", "min": 7500, "max": 15000, "priority": 3, 
            "heat_a": 3.2e-06, "heat_b": 0.1430, "heat_c": 300,
            "startup_cost": 50630, "shutdown_cost": 65729},
        3: {"name": "DG6", "type": "DG", "min": 6000, "max": 12000, "priority": 4, 
            "heat_a": 1.0e-06, "heat_b": 0.1900, "heat_c": 216,
            "startup_cost": 13580, "shutdown_cost": 13097},
        4: {"name": "DG7", "type": "DG", "min": 6000, "max": 12000, "priority": 5, 
            "heat_a": 5.0e-06, "heat_b": 0.1100, "heat_c": 612,
            "startup_cost": 13580, "shutdown_cost": 13097},
        5: {"name": "GT1", "type": "GT", "min": 2500, "max": 5000, "priority": 6, 
            "heat_a": 2.0e-06, "heat_b": 0.1500, "heat_c": 800,
            "startup_cost": 12748, "shutdown_cost": 26643},
        6: {"name": "GT2", "type": "GT", "min": 2500, "max": 5000, "priority": 7, 
            "heat_a": 2.0e-06, "heat_b": 0.1500, "heat_c": 800,
            "startup_cost": 12748, "shutdown_cost": 26643},
        7: {"name": "GT3", "type": "GT", "min": 2500, "max": 5000, "priority": 8, 
            "heat_a": 2.0e-06, "heat_b": 0.1500, "heat_c": 800,
            "startup_cost": 12748, "shutdown_cost": 26643}
    }
    
    if index in defaults:
        return defaults[index]
    else:
        return {"name": f"ç™ºé›»æ©Ÿ{index+1}", "type": "DG", "min": 1000, "max": 5000, "priority": index+1,
                "heat_a": 1.0e-06, "heat_b": 0.1500, "heat_c": 300,
                "startup_cost": 10000, "shutdown_cost": 10000}

# ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: è¨­å®šå€¤ã®æ›´æ–°
@app.callback(
    Output('solver-config-store', 'data'),
    [Input('margin-dg-slider', 'value'),
     Input('margin-gt-slider', 'value'),
     Input('stop-margin-dg-slider', 'value'),
     Input('stop-margin-gt-slider', 'value'),
     Input('lambda-min-input', 'value'),
     Input('lambda-max-input', 'value'),
     Input('lambda-tolerance-input', 'value')],
    [State('solver-config-store', 'data')]
)
def update_solver_config(margin_dg, margin_gt, stop_margin_dg, stop_margin_gt,
                        lambda_min, lambda_max, lambda_tolerance, current_config):
    """è¨­å®šå€¤ã‚’æ›´æ–°"""
    return {
        'margin_dg': margin_dg / 100 if margin_dg is not None else current_config['margin_dg'],
        'margin_gt': margin_gt / 100 if margin_gt is not None else current_config['margin_gt'],
        'stop_margin_dg': stop_margin_dg / 100 if stop_margin_dg is not None else current_config['stop_margin_dg'],
        'stop_margin_gt': stop_margin_gt / 100 if stop_margin_gt is not None else current_config['stop_margin_gt'],
        'lambda_min': lambda_min if lambda_min is not None else current_config['lambda_min'],
        'lambda_max': lambda_max if lambda_max is not None else current_config['lambda_max'],
        'lambda_tolerance': lambda_tolerance if lambda_tolerance is not None else current_config['lambda_tolerance']
    }

# ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
@app.callback(
    [Output('demand-store', 'data'),
     Output('demand-upload-status', 'children'),
     Output('demand-preview', 'children')],
    [Input('upload-demand', 'contents')],
    [State('upload-demand', 'filename')]
)
def upload_demand_data(contents, filename):
    """éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"""
    if contents is None:
        return None, "", ""
    
    try:
        content_type, content_string = contents.split(',')
        decoded = base64.b64decode(content_string)
        
        # ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡º
        encodings = ['utf-8', 'shift-jis', 'cp932', 'euc-jp', 'iso-2022-jp']
        df = None
        
        for encoding in encodings:
            try:
                df = pd.read_csv(io.StringIO(decoded.decode(encoding)))
                break
            except UnicodeDecodeError:
                continue
        
        if df is None:
            return None, html.Div("âŒ ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ", 
                                 style={'color': 'red'}), ""
        
        if len(df.columns) < 2:
            return None, html.Div("âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã«æœ€ä½2åˆ—ï¼ˆæ™‚åˆ»ã€éœ€è¦ï¼‰ãŒå¿…è¦ã§ã™", 
                                 style={'color': 'red'}), ""
        
        if len(df) < 96:
            return None, html.Div(f"âŒ ãƒ‡ãƒ¼ã‚¿ãŒ96ã‚¹ãƒ†ãƒƒãƒ—æœªæº€ã§ã™ï¼ˆç¾åœ¨: {len(df)}ã‚¹ãƒ†ãƒƒãƒ—ï¼‰", 
                                 style={'color': 'red'}), ""
        
        # éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’æ•°å€¤ã«å¤‰æ›
        demand_column = df.columns[1]  # 2åˆ—ç›®ã‚’éœ€è¦ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨
        demand_values = pd.to_numeric(df[demand_column], errors='coerce').values[:96]
        
        valid_count = np.sum(~np.isnan(demand_values))
        
        # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆ
        preview_df = df.head(10)
        preview_table = dash_table.DataTable(
            data=preview_df.to_dict('records'),
            columns=[{"name": i, "id": i} for i in preview_df.columns],
            style_cell={'textAlign': 'left'},
            style_header={'backgroundColor': 'rgb(230, 230, 230)', 'fontWeight': 'bold'}
        )
        
        # çµ±è¨ˆæƒ…å ±
        valid_demands = demand_values[~np.isnan(demand_values)]
        stats = html.Div([
            html.H4("éœ€è¦ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ"),
            html.P(f"æœ€å°å€¤: {valid_demands.min():.0f} kW"),
            html.P(f"å¹³å‡å€¤: {valid_demands.mean():.0f} kW"),
            html.P(f"æœ€å¤§å€¤: {valid_demands.max():.0f} kW"),
            html.P(f"éœ€è¦å¹…: {valid_demands.max() - valid_demands.min():.0f} kW"),
        ])
        
        status = html.Div([
            html.Div(f"âœ… éœ€è¦äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆ{valid_count}/96ã‚¹ãƒ†ãƒƒãƒ—æœ‰åŠ¹ï¼‰", 
                     style={'color': 'green'}),
            stats
        ])
        
        preview = html.Div([
            html.H4("ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"),
            preview_table
        ])
        
        return demand_values.tolist(), status, preview
        
    except Exception as e:
        return None, html.Div(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}", style={'color': 'red'}), ""

# ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç™ºé›»æ©Ÿè¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
@app.callback(
    Output('generator-config-table', 'children'),
    [Input('generate-gen-table-btn', 'n_clicks')],
    [State('num-generators-input', 'value')]
)
def generate_generator_table(n_clicks, num_generators):
    """ç™ºé›»æ©Ÿè¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ"""
    if n_clicks is None or num_generators is None:
        return ""
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    table_data = []
    for i in range(num_generators):
        config = get_default_generator_config(i)
        table_data.append({
            'ID': i,
            'åå‰': config['name'],
            'ã‚¿ã‚¤ãƒ—': config['type'],
            'æœ€å°å‡ºåŠ›(kW)': config['min'],
            'æœ€å¤§å‡ºåŠ›(kW)': config['max'],
            'å„ªå…ˆé †ä½': config['priority'],
            'æœ€å°é‹è»¢æ™‚é–“(h)': 2.0,
            'æœ€å°åœæ­¢æ™‚é–“(h)': 1.0,
            'ãƒã‚¹ãƒˆãƒ©ãƒ³': False,
            'aä¿‚æ•°': f"{config['heat_a']:.2e}",
            'bä¿‚æ•°': f"{config['heat_b']:.4f}",
            'cä¿‚æ•°': config['heat_c'],
            'ç‡ƒæ–™å˜ä¾¡(å††/kL)': 60354,
            'èµ·å‹•è²»(å††)': config['startup_cost'],
            'åœæ­¢è²»(å††)': config['shutdown_cost']
        })
    
    table = dash_table.DataTable(
        id='generator-table',
        data=table_data,
        columns=[
            {"name": "ID", "id": "ID", "editable": False},
            {"name": "åå‰", "id": "åå‰", "editable": True},
            {"name": "ã‚¿ã‚¤ãƒ—", "id": "ã‚¿ã‚¤ãƒ—", "editable": True, "presentation": "dropdown"},
            {"name": "æœ€å°å‡ºåŠ›(kW)", "id": "æœ€å°å‡ºåŠ›(kW)", "editable": True, "type": "numeric"},
            {"name": "æœ€å¤§å‡ºåŠ›(kW)", "id": "æœ€å¤§å‡ºåŠ›(kW)", "editable": True, "type": "numeric"},
            {"name": "å„ªå…ˆé †ä½", "id": "å„ªå…ˆé †ä½", "editable": True, "type": "numeric"},
            {"name": "æœ€å°é‹è»¢æ™‚é–“(h)", "id": "æœ€å°é‹è»¢æ™‚é–“(h)", "editable": True, "type": "numeric"},
            {"name": "æœ€å°åœæ­¢æ™‚é–“(h)", "id": "æœ€å°åœæ­¢æ™‚é–“(h)", "editable": True, "type": "numeric"},
            {"name": "ãƒã‚¹ãƒˆãƒ©ãƒ³", "id": "ãƒã‚¹ãƒˆãƒ©ãƒ³", "editable": True, "type": "text"},
            {"name": "aä¿‚æ•°", "id": "aä¿‚æ•°", "editable": True},
            {"name": "bä¿‚æ•°", "id": "bä¿‚æ•°", "editable": True, "type": "numeric"},
            {"name": "cä¿‚æ•°", "id": "cä¿‚æ•°", "editable": True, "type": "numeric"},
            {"name": "ç‡ƒæ–™å˜ä¾¡(å††/kL)", "id": "ç‡ƒæ–™å˜ä¾¡(å††/kL)", "editable": True, "type": "numeric"},
            {"name": "èµ·å‹•è²»(å††)", "id": "èµ·å‹•è²»(å††)", "editable": True, "type": "numeric"},
            {"name": "åœæ­¢è²»(å††)", "id": "åœæ­¢è²»(å††)", "editable": True, "type": "numeric"},
        ],
        dropdown={
            'ã‚¿ã‚¤ãƒ—': {
                'options': [
                    {'label': 'DG', 'value': 'DG'},
                    {'label': 'GT', 'value': 'GT'}
                ]
            }
        },
        editable=True,
        style_cell={'textAlign': 'left', 'fontSize': '12px'},
        style_header={'backgroundColor': 'rgb(230, 230, 230)', 'fontWeight': 'bold'},
        style_table={'overflowX': 'auto'}
    )
    
    return table

# ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç™ºé›»æ©Ÿè¨­å®šä¿å­˜
@app.callback(
    [Output('generators-store', 'data'),
     Output('generator-save-status', 'children')],
    [Input('save-generators-btn', 'n_clicks')],
    [State('generator-table', 'data')]
)
def save_generators(n_clicks, table_data):
    """ç™ºé›»æ©Ÿè¨­å®šã‚’ä¿å­˜"""
    if n_clicks is None or table_data is None:
        return None, ""
    
    try:
        generators = []
        for row in table_data:
            # aä¿‚æ•°ã®å‡¦ç†ï¼ˆæ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã«å¤‰æ›ï¼‰
            heat_a_str = str(row.get('aä¿‚æ•°', '1e-06'))
            if 'e' in heat_a_str.lower():
                heat_a = float(heat_a_str)
            else:
                heat_a = float(heat_a_str)
            
            # ãƒã‚¹ãƒˆãƒ©ãƒ³ã®å‡¦ç†
            must_run_str = str(row.get('ãƒã‚¹ãƒˆãƒ©ãƒ³', 'False')).lower()
            is_must_run = must_run_str in ['true', '1', 'yes', 'ã¯ã„', 'on']
            
            generator = {
                'name': row.get('åå‰', f"ç™ºé›»æ©Ÿ{row.get('ID', 0)+1}"),
                'unit_type': row.get('ã‚¿ã‚¤ãƒ—', 'DG'),
                'min_output': float(row.get('æœ€å°å‡ºåŠ›(kW)', 1000)),
                'max_output': float(row.get('æœ€å¤§å‡ºåŠ›(kW)', 5000)),
                'priority': int(row.get('å„ªå…ˆé †ä½', 1)),
                'min_run_time': float(row.get('æœ€å°é‹è»¢æ™‚é–“(h)', 2.0)),
                'min_stop_time': float(row.get('æœ€å°åœæ­¢æ™‚é–“(h)', 1.0)),
                'is_must_run': is_must_run,
                'heat_rate_a': heat_a,
                'heat_rate_b': float(row.get('bä¿‚æ•°', 0.15)),
                'heat_rate_c': float(row.get('cä¿‚æ•°', 300)),
                'fuel_price': float(row.get('ç‡ƒæ–™å˜ä¾¡(å††/kL)', 60354)),
                'startup_cost': float(row.get('èµ·å‹•è²»(å††)', 10000)),
                'shutdown_cost': float(row.get('åœæ­¢è²»(å††)', 10000))
            }
            generators.append(generator)
        
        status = html.Div("âœ… ç™ºé›»æ©Ÿè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ", style={'color': 'green'})
        return generators, status
        
    except Exception as e:
        status = html.Div(f"âŒ ç™ºé›»æ©Ÿè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}", style={'color': 'red'})
        return None, status

# Unit Commitmentã‚½ãƒ«ãƒãƒ¼ï¼ˆç°¡ç•¥ç‰ˆï¼‰
class SimpleUnitCommitmentSolver:
    def __init__(self, config):
        self.config = config
    
    def solve(self, generators, demand_data):
        """ç°¡ç•¥åŒ–ã•ã‚ŒãŸæ§‹æˆè¨ˆç®—"""
        time_steps = len(demand_data)
        gen_count = len(generators)
        
        # å„ªå…ˆé †ä½ã§ã‚½ãƒ¼ãƒˆ
        sorted_generators = sorted(generators, key=lambda x: x['priority'])
        
        # å‡ºåŠ›ãƒ•ãƒ©ã‚°åˆæœŸåŒ–
        output_flags = np.zeros((gen_count, time_steps), dtype=int)
        
        for t in range(time_steps):
            demand = demand_data[t]
            if np.isnan(demand):
                continue
            
            # å¿…è¦ãªå®¹é‡è¨ˆç®—ï¼ˆãƒãƒ¼ã‚¸ãƒ³è€ƒæ…®ï¼‰
            required_capacity = demand * (1 + max(self.config['margin_dg'], self.config['margin_gt']))
            
            # ç™ºé›»æ©Ÿã‚’å„ªå…ˆé †ä½é †ã«é¸æŠ
            cumulative_capacity = 0
            
            for i, gen in enumerate(sorted_generators):
                if gen['is_must_run'] or cumulative_capacity < required_capacity:
                    output_flags[i, t] = 1
                    cumulative_capacity += gen['max_output']
        
        return {
            'generators': sorted_generators,
            'output_flags': output_flags.tolist(),  # numpyé…åˆ—ã‚’ãƒªã‚¹ãƒˆã«å¤‰æ›
            'demand_data': demand_data,
            'time_steps': time_steps
        }

# Economic Dispatchã‚½ãƒ«ãƒãƒ¼ï¼ˆç°¡ç•¥ç‰ˆï¼‰
class SimpleEconomicDispatchSolver:
    def __init__(self, config):
        self.config = config
    
    def solve(self, uc_result):
        """ç°¡ç•¥åŒ–ã•ã‚ŒãŸçµŒæ¸ˆé…åˆ†è¨ˆç®—"""
        generators = uc_result['generators']
        output_flags = np.array(uc_result['output_flags'])  # ãƒªã‚¹ãƒˆã‚’numpyé…åˆ—ã«å¤‰æ›
        demand_data = uc_result['demand_data']
        time_steps = uc_result['time_steps']
        
        gen_count = len(generators)
        power_outputs = np.zeros((gen_count, time_steps))
        lambda_values = np.zeros(time_steps)
        
        for t in range(time_steps):
            demand = demand_data[t]
            if np.isnan(demand):
                continue
            
            # é‹è»¢ä¸­ç™ºé›»æ©Ÿã‚’æŠ½å‡º
            running_generators = []
            for i, gen in enumerate(generators):
                if output_flags[i, t] == 1:
                    running_generators.append((i, gen))
            
            if not running_generators:
                continue
            
            # ç­‰é…åˆ†æ–¹å¼ï¼ˆç°¡ç•¥åŒ–ï¼‰
            total_capacity = sum(gen['max_output'] for _, gen in running_generators)
            
            for i, gen in running_generators:
                # å®¹é‡æ¯”ä¾‹é…åˆ†
                allocation_ratio = gen['max_output'] / total_capacity
                output = min(demand * allocation_ratio, gen['max_output'])
                output = max(output, gen['min_output'])
                power_outputs[i, t] = output
            
            # Î»å€¤è¨ˆç®—ï¼ˆç°¡ç•¥åŒ–ï¼‰
            lambda_values[t] = 50.0  # å›ºå®šå€¤
        
        # ã‚³ã‚¹ãƒˆè¨ˆç®—
        total_costs = self.calculate_costs(generators, power_outputs, output_flags)
        
        return {
            'power_outputs': power_outputs.tolist(),  # numpyé…åˆ—ã‚’ãƒªã‚¹ãƒˆã«å¤‰æ›
            'lambda_values': lambda_values.tolist(),  # numpyé…åˆ—ã‚’ãƒªã‚¹ãƒˆã«å¤‰æ›
            'total_costs': total_costs
        }
    
    def calculate_costs(self, generators, power_outputs, output_flags):
        """ã‚³ã‚¹ãƒˆè¨ˆç®—"""
        time_steps = power_outputs.shape[1]
        total_fuel_cost = 0
        
        for i, gen in enumerate(generators):
            for t in range(time_steps):
                if output_flags[i, t] == 1:
                    power = power_outputs[i, t]
                    # ç‡ƒæ–™è²»è¨ˆç®—
                    fuel_consumption = (gen['heat_rate_a'] * power**2 + 
                                      gen['heat_rate_b'] * power + 
                                      gen['heat_rate_c'])
                    cost = fuel_consumption * gen['fuel_price'] * 0.25
                    total_fuel_cost += cost
        
        return {
            'total_cost': total_fuel_cost,
            'total_fuel_cost': total_fuel_cost,
            'total_startup_cost': 0,
            'total_shutdown_cost': 0,
            'average_cost_per_hour': total_fuel_cost / 24
        }

# ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: è¨ˆç®—å®Ÿè¡Œ
@app.callback(
    [Output('uc-result-store', 'data'),
     Output('ed-result-store', 'data'),
     Output('calculation-status', 'children'),
     Output('results-section', 'style')],
    [Input('run-uc-btn', 'n_clicks'),
     Input('run-both-btn', 'n_clicks')],
    [State('generators-store', 'data'),
     State('demand-store', 'data'),
     State('solver-config-store', 'data')]
)
def run_calculations(uc_clicks, both_clicks, generators, demand_data, config):
    """è¨ˆç®—ã‚’å®Ÿè¡Œ"""
    ctx = callback_context
    if not ctx.triggered:
        return None, None, "", {'display': 'none'}
    
    button_id = ctx.triggered[0]['prop_id'].split('.')[0]
    
    if generators is None or demand_data is None:
        missing = []
        if generators is None:
            missing.append("ç™ºé›»æ©Ÿè¨­å®š")
        if demand_data is None:
            missing.append("éœ€è¦ãƒ‡ãƒ¼ã‚¿")
        
        status = html.Div(f"âš ï¸ ä»¥ä¸‹ã®è¨­å®šãŒå¿…è¦ã§ã™: {', '.join(missing)}", 
                         style={'color': 'orange'})
        return None, None, status, {'display': 'none'}
    
    try:
        # Unit Commitmentè¨ˆç®—
        uc_solver = SimpleUnitCommitmentSolver(config)
        uc_result = uc_solver.solve(generators, demand_data)
        
        ed_result = None
        if button_id == 'run-both-btn':
            # Economic Dispatchè¨ˆç®—
            ed_solver = SimpleEconomicDispatchSolver(config)
            ed_result = ed_solver.solve(uc_result)
        
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        if button_id == 'run-uc-btn':
            status = html.Div("âœ… æ§‹æˆè¨ˆç®—å®Œäº†ï¼", style={'color': 'green'})
        else:
            status = html.Div("âœ… æ§‹æˆè¨ˆç®—ï¼‹çµŒæ¸ˆé…åˆ†å®Œäº†ï¼", style={'color': 'green'})
        
        return uc_result, ed_result, status, {'display': 'block'}
        
    except Exception as e:
        status = html.Div(f"âŒ è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {e}", style={'color': 'red'})
        return None, None, status, {'display': 'none'}

# ãƒãƒ£ãƒ¼ãƒˆä½œæˆé–¢æ•°
def create_unit_commitment_chart(uc_result):
    """æ§‹æˆè¨ˆç®—ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ"""
    if not uc_result:
        return go.Figure()
    
    generators = uc_result['generators']
    output_flags = np.array(uc_result['output_flags'])  # ãƒªã‚¹ãƒˆã‚’numpyé…åˆ—ã«å¤‰æ›
    demand_data = uc_result['demand_data']
    time_steps = uc_result['time_steps']
    
    # æ™‚é–“è»¸ä½œæˆ
    time_labels = []
    for i in range(time_steps):
        hour = (i * 15) // 60
        minute = (i * 15) % 60
        time_labels.append(f"{hour:02d}:{minute:02d}")
    
    # ã‚µãƒ–ãƒ—ãƒ­ãƒƒãƒˆä½œæˆ
    fig = make_subplots(
        rows=2, cols=1,
        subplot_titles=('ç™ºé›»æ©Ÿæ§‹æˆãƒ»éœ€è¦', 'ç™ºé›»æ©ŸçŠ¶æ…‹'),
        row_heights=[0.7, 0.3],
        vertical_spacing=0.1
    )
    
    # è‰²è¨­å®š
    colors = px.colors.qualitative.Set3
    
    # ç™ºé›»æ©Ÿå‡ºåŠ›ã®ç©ã¿ä¸Šã’
    y_stack = np.zeros(time_steps)
    
    for i, gen in enumerate(generators):
        y_values = []
        for t in range(time_steps):
            if output_flags[i, t] == 1:
                y_values.append(gen['max_output'])
            else:
                y_values.append(0)
        
        y_upper = y_stack + np.array(y_values)
        
        fig.add_trace(
            go.Scatter(
                x=time_labels,
                y=y_upper,
                fill='tonexty' if i > 0 else 'tozeroy',
                mode='none',
                name=gen['name'],
                fillcolor=colors[i % len(colors)],
                hovertemplate=f'{gen["name"]}: %{{y:.0f}} kW<br>æ™‚åˆ»: %{{x}}<extra></extra>'
            ),
            row=1, col=1
        )
        
        y_stack = y_upper
    
    # éœ€è¦ãƒ©ã‚¤ãƒ³
    fig.add_trace(
        go.Scatter(
            x=time_labels,
            y=demand_data,
            mode='lines',
            name='éœ€è¦',
            line=dict(color='red', width=3),
            hovertemplate='éœ€è¦: %{y:.0f} kW<br>æ™‚åˆ»: %{x}<extra></extra>'
        ),
        row=1, col=1
    )
    
    # ç™ºé›»æ©ŸçŠ¶æ…‹è¡¨ç¤ºï¼ˆä¸‹æ®µï¼‰
    for i, gen in enumerate(generators):
        status_text = []
        for t in range(time_steps):
            if output_flags[i, t] == 0:
                status_text.append('åœæ­¢')
            elif output_flags[i, t] == 1:
                status_text.append('é‹è»¢')
            else:
                status_text.append('èµ·å‹•ä¸­')
        
        fig.add_trace(
            go.Scatter(
                x=time_labels,
                y=[i] * time_steps,
                mode='markers',
                marker=dict(
                    color=[0 if s == 'åœæ­¢' else 1 if s == 'é‹è»¢' else 0.5 for s in status_text],
                    colorscale=[[0, 'gray'], [0.5, 'orange'], [1, 'green']],
                    size=8,
                    symbol='square'
                ),
                name=f'{gen["name"]}_çŠ¶æ…‹',
                text=status_text,
                hovertemplate=f'{gen["name"]}: %{{text}}<br>æ™‚åˆ»: %{{x}}<extra></extra>',
                showlegend=False
            ),
            row=2, col=1
        )
    
    # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
    fig.update_layout(
        title='ç™ºé›»æ©Ÿæ§‹æˆè¨ˆç®—çµæœ',
        height=800,
        hovermode='x unified'
    )
    
    fig.update_xaxes(title_text="æ™‚åˆ»", row=2, col=1)
    fig.update_yaxes(title_text="å‡ºåŠ› (kW)", row=1, col=1)
    fig.update_yaxes(
        title_text="ç™ºé›»æ©Ÿ",
        row=2, col=1,
        tickmode='array',
        tickvals=list(range(len(generators))),
        ticktext=[gen['name'] for gen in generators]
    )
    
    return fig

def create_economic_dispatch_chart(uc_result, ed_result):
    """çµŒæ¸ˆé…åˆ†ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ"""
    if not uc_result or not ed_result:
        return go.Figure()
    
    generators = uc_result['generators']
    power_outputs = np.array(ed_result['power_outputs'])  # ãƒªã‚¹ãƒˆã‚’numpyé…åˆ—ã«å¤‰æ›
    lambda_values = ed_result['lambda_values']
    demand_data = uc_result['demand_data']
    time_steps = uc_result['time_steps']
    
    # æ™‚é–“è»¸ä½œæˆ
    time_labels = []
    for i in range(time_steps):
        hour = (i * 15) // 60
        minute = (i * 15) % 60
        time_labels.append(f"{hour:02d}:{minute:02d}")
    
    # ã‚µãƒ–ãƒ—ãƒ­ãƒƒãƒˆä½œæˆ
    fig = make_subplots(
        rows=3, cols=1,
        subplot_titles=('ç™ºé›»æ©Ÿå‡ºåŠ›é…åˆ†', 'Î»å€¤æ¨ç§»', 'ç‡ƒæ–™è²»'),
        row_heights=[0.5, 0.25, 0.25],
        vertical_spacing=0.08
    )
    
    # è‰²è¨­å®š
    colors = px.colors.qualitative.Set3
    
    # ç™ºé›»æ©Ÿå‡ºåŠ›ã®ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•
    for i, gen in enumerate(generators):
        y_values = power_outputs[i, :]
        
        fig.add_trace(
            go.Bar(
                x=time_labels,
                y=y_values,
                name=gen['name'],
                marker_color=colors[i % len(colors)],
                hovertemplate=f'{gen["name"]}: %{{y:.1f}} kW<br>æ™‚åˆ»: %{{x}}<extra></extra>',
                opacity=0.8
            ),
            row=1, col=1
        )
    
    # éœ€è¦ãƒ©ã‚¤ãƒ³
    fig.add_trace(
        go.Scatter(
            x=time_labels,
            y=demand_data,
            mode='lines',
            name='éœ€è¦',
            line=dict(color='red', width=3, dash='dash'),
            hovertemplate='éœ€è¦: %{y:.1f} kW<br>æ™‚åˆ»: %{x}<extra></extra>'
        ),
        row=1, col=1
    )
    
    # Î»å€¤æ¨ç§»
    fig.add_trace(
        go.Scatter(
            x=time_labels,
            y=lambda_values,
            mode='lines+markers',
            name='Î»å€¤',
            line=dict(color='purple', width=2),
            marker=dict(size=4),
            hovertemplate='Î»å€¤: %{y:.3f}<br>æ™‚åˆ»: %{x}<extra></extra>',
            showlegend=False
        ),
        row=2, col=1
    )
    
    # ç‡ƒæ–™è²»ï¼ˆå›ºå®šå€¤ã¨ã—ã¦è¡¨ç¤ºï¼‰
    hourly_costs = [ed_result['total_costs']['average_cost_per_hour']] * time_steps
    
    fig.add_trace(
        go.Scatter(
            x=time_labels,
            y=hourly_costs,
            mode='lines',
            name='ç‡ƒæ–™è²»',
            line=dict(color='orange', width=2),
            fill='tozeroy',
            fillcolor='rgba(255, 165, 0, 0.3)',
            hovertemplate='ç‡ƒæ–™è²»: %{y:.0f} å††/h<br>æ™‚åˆ»: %{x}<extra></extra>',
            showlegend=False
        ),
        row=3, col=1
    )
    
    # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
    fig.update_layout(
        title='çµŒæ¸ˆé…åˆ†è¨ˆç®—çµæœ',
        height=900,
        hovermode='x unified',
        barmode='stack'
    )
    
    fig.update_xaxes(title_text="æ™‚åˆ»", row=3, col=1)
    fig.update_yaxes(title_text="å‡ºåŠ› (kW)", row=1, col=1)
    fig.update_yaxes(title_text="Î»å€¤", row=2, col=1)
    fig.update_yaxes(title_text="ç‡ƒæ–™è²» (å††/h)", row=3, col=1)
    
    return fig

# ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: çµæœè¡¨ç¤º
@app.callback(
    Output('result-content', 'children'),
    [Input('result-tabs', 'value')],
    [State('uc-result-store', 'data'),
     State('ed-result-store', 'data')]
)
def display_results(active_tab, uc_result, ed_result):
    """çµæœã‚’è¡¨ç¤º"""
    if not uc_result:
        return html.Div("è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚", style={'color': 'gray'})
    
    if active_tab == 'uc-tab':
        # æ§‹æˆè¨ˆç®—çµæœ
        fig = create_unit_commitment_chart(uc_result)
        
        # çµ±è¨ˆæƒ…å ±
        generators = uc_result['generators']
        output_flags = np.array(uc_result['output_flags'])  # ãƒªã‚¹ãƒˆã‚’numpyé…åˆ—ã«å¤‰æ›
        
        running_units_per_time = []
        for t in range(96):
            running_count = np.sum(output_flags[:, t] == 1)
            running_units_per_time.append(running_count)
        
        min_running = min(running_units_per_time)
        max_running = max(running_units_per_time)
        avg_running = np.mean(running_units_per_time)
        efficiency = (1 - avg_running / len(generators)) * 100
        
        min_running = min(running_units_per_time)
        max_running = max(running_units_per_time)
        avg_running = np.mean(running_units_per_time)
        efficiency = (1 - avg_running / len(generators)) * 100
        
        stats = html.Div([
            html.H3("âš™ï¸ æœ€å°å°æ•°æ§‹æˆåˆ†æ"),
            html.Div([
                html.Div([
                    html.H4(f"{min_running} å°"),
                    html.P("æœ€å°é‹è»¢å°æ•°")
                ], style={'width': '24%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{max_running} å°"),
                    html.P("æœ€å¤§é‹è»¢å°æ•°")
                ], style={'width': '24%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{avg_running:.1f} å°"),
                    html.P("å¹³å‡é‹è»¢å°æ•°")
                ], style={'width': '24%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{efficiency:.1f}%"),
                    html.P("æ§‹æˆåŠ¹ç‡")
                ], style={'width': '24%', 'display': 'inline-block', 'text-align': 'center'}),
            ], style={'margin': '1rem 0'})
        ])
        
        return html.Div([
            dcc.Graph(figure=fig),
            stats
        ])
    
    elif active_tab == 'ed-tab':
        # çµŒæ¸ˆé…åˆ†çµæœ
        if not ed_result:
            return html.Div("çµŒæ¸ˆé…åˆ†è¨ˆç®—ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", style={'color': 'orange'})
        
        fig = create_economic_dispatch_chart(uc_result, ed_result)
        
        # çµŒæ¸ˆçµ±è¨ˆ
        costs = ed_result['total_costs']
        lambda_values = np.array(ed_result['lambda_values'])  # ãƒªã‚¹ãƒˆã‚’numpyé…åˆ—ã«å¤‰æ›
        
        stats = html.Div([
            html.H3("ğŸ’° çµŒæ¸ˆé…åˆ†çµ±è¨ˆ"),
            html.Div([
                html.Div([
                    html.H4(f"{lambda_values.min():.3f}"),
                    html.P("Î»æœ€å°å€¤")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{lambda_values.max():.3f}"),
                    html.P("Î»æœ€å¤§å€¤")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{lambda_values.mean():.3f}"),
                    html.P("Î»å¹³å‡å€¤")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{costs['total_cost']:.0f} å††"),
                    html.P("ç·ã‚³ã‚¹ãƒˆ")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{costs['average_cost_per_hour']:.0f} å††/æ™‚"),
                    html.P("å¹³å‡ã‚³ã‚¹ãƒˆ")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
            ], style={'margin': '1rem 0'})
        ])
        
        return html.Div([
            dcc.Graph(figure=fig),
            stats
        ])[:, t] == 1)
            running_units_per_time.append(running_count)
        
        min_running = min(running_units_per_time)
        max_running = max(running_units_per_time)
        avg_running = np.mean(running_units_per_time)
        efficiency = (1 - avg_running / len(generators)) * 100
        
        stats = html.Div([
            html.H3("âš™ï¸ æœ€å°å°æ•°æ§‹æˆåˆ†æ"),
            html.Div([
                html.Div([
                    html.H4(f"{min_running} å°"),
                    html.P("æœ€å°é‹è»¢å°æ•°")
                ], style={'width': '24%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{max_running} å°"),
                    html.P("æœ€å¤§é‹è»¢å°æ•°")
                ], style={'width': '24%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{avg_running:.1f} å°"),
                    html.P("å¹³å‡é‹è»¢å°æ•°")
                ], style={'width': '24%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{efficiency:.1f}%"),
                    html.P("æ§‹æˆåŠ¹ç‡")
                ], style={'width': '24%', 'display': 'inline-block', 'text-align': 'center'}),
            ], style={'margin': '1rem 0'})
        ])
        
        return html.Div([
            dcc.Graph(figure=fig),
            stats
        ])
    
    elif active_tab == 'ed-tab':
        # çµŒæ¸ˆé…åˆ†çµæœ
        if not ed_result:
            return html.Div("çµŒæ¸ˆé…åˆ†è¨ˆç®—ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", style={'color': 'orange'})
        
        fig = create_economic_dispatch_chart(uc_result, ed_result)
        
        # çµŒæ¸ˆçµ±è¨ˆ
        costs = ed_result['total_costs']
        lambda_values = ed_result['lambda_values']
        
        stats = html.Div([
            html.H3("ğŸ’° çµŒæ¸ˆé…åˆ†çµ±è¨ˆ"),
            html.Div([
                html.Div([
                    html.H4(f"{lambda_values.min():.3f}"),
                    html.P("Î»æœ€å°å€¤")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{lambda_values.max():.3f}"),
                    html.P("Î»æœ€å¤§å€¤")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{lambda_values.mean():.3f}"),
                    html.P("Î»å¹³å‡å€¤")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{costs['total_cost']:.0f} å††"),
                    html.P("ç·ã‚³ã‚¹ãƒˆ")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
                html.Div([
                    html.H4(f"{costs['average_cost_per_hour']:.0f} å††/æ™‚"),
                    html.P("å¹³å‡ã‚³ã‚¹ãƒˆ")
                ], style={'width': '19%', 'display': 'inline-block', 'text-align': 'center'}),
            ], style={'margin': '1rem 0'})
        ])
        
        return html.Div([
            dcc.Graph(figure=fig),
            stats
        ])
    
    elif active_tab == 'stats-tab':
        # çµ±è¨ˆæƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«
        generators = uc_result['generators']
        output_flags = np.array(uc_result['output_flags'])  # ãƒªã‚¹ãƒˆã‚’numpyé…åˆ—ã«å¤‰æ›
        
        stats_data = []
        for i, gen in enumerate(generators):
            running_steps = np.sum(output_flags[i, :] == 1)
            running_hours = running_steps * 0.25
            utilization = (running_steps / 96) * 100
            
            # èµ·å‹•å›æ•°è¨ˆç®—
            start_count = 0
            for j in range(1, 96):
                if output_flags[i, j] == 1 and output_flags[i, j-1] == 0:
                    start_count += 1
            
            row_data = {
                'ç™ºé›»æ©Ÿ': gen['name'],
                'ã‚¿ã‚¤ãƒ—': gen['unit_type'],
                'å„ªå…ˆé †ä½': gen['priority'],
                'é‹è»¢æ™‚é–“': f"{running_hours:.1f}h",
                'ç¨¼åƒç‡': f"{utilization:.1f}%",
                'èµ·å‹•å›æ•°': start_count,
                'ãƒã‚¹ãƒˆãƒ©ãƒ³': 'â—‹' if gen['is_must_run'] else 'Ã—'
            }
            
            # çµŒæ¸ˆé…åˆ†çµæœãŒã‚ã‚‹å ´åˆã¯å‡ºåŠ›çµ±è¨ˆã‚‚è¿½åŠ 
            if ed_result:
                power_outputs = np.array(ed_result['power_outputs'])  # ãƒªã‚¹ãƒˆã‚’numpyé…åˆ—ã«å¤‰æ›
                running_outputs = power_outputs[i, power_outputs[i, :] > 0]
                if len(running_outputs) > 0:
                    avg_output = np.mean(running_outputs)
                    max_output = np.max(power_outputs[i, :])
                    total_generation = np.sum(power_outputs[i, :]) * 0.25
                    
                    row_data.update({
                        'å¹³å‡å‡ºåŠ›': f"{avg_output:.1f} kW",
                        'æœ€å¤§å‡ºåŠ›': f"{max_output:.1f} kW",
                        'ç·ç™ºé›»é‡': f"{total_generation:.1f} kWh"
                    })
            
            stats_data.append(row_data)
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—è¨­å®š
        columns = [
            {"name": "ç™ºé›»æ©Ÿ", "id": "ç™ºé›»æ©Ÿ"},
            {"name": "ã‚¿ã‚¤ãƒ—", "id": "ã‚¿ã‚¤ãƒ—"},
            {"name": "å„ªå…ˆé †ä½", "id": "å„ªå…ˆé †ä½"},
            {"name": "é‹è»¢æ™‚é–“", "id": "é‹è»¢æ™‚é–“"},
            {"name": "ç¨¼åƒç‡", "id": "ç¨¼åƒç‡"},
            {"name": "èµ·å‹•å›æ•°", "id": "èµ·å‹•å›æ•°"},
            {"name": "ãƒã‚¹ãƒˆãƒ©ãƒ³", "id": "ãƒã‚¹ãƒˆãƒ©ãƒ³"}
        ]
        
        if ed_result:
            columns.extend([
                {"name": "å¹³å‡å‡ºåŠ›", "id": "å¹³å‡å‡ºåŠ›"},
                {"name": "æœ€å¤§å‡ºåŠ›", "id": "æœ€å¤§å‡ºåŠ›"},
                {"name": "ç·ç™ºé›»é‡", "id": "ç·ç™ºé›»é‡"}
            ])
        
        table = dash_table.DataTable(
            data=stats_data,
            columns=columns,
            style_cell={'textAlign': 'left'},
            style_header={'backgroundColor': 'rgb(230, 230, 230)', 'fontWeight': 'bold'},
            style_table={'margin': '1rem 0'}
        )
        
        return html.Div([
            html.H3("ğŸ“Š é‹è»¢çµ±è¨ˆ"),
            table
        ])
    
    return html.Div()

if __name__ == '__main__':
    app.run(debug=True)
